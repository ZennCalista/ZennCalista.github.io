<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>eTracker Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="design.css" />
</head>
<body>
  <div class="card-container">
    <!-- Left Panel -->
    <div class="left-card">
      <img src="logo.png" alt="Logo" class="logo" />
      <div class="title">Extension Services</div>
      <p class="description">
        Track projects and connect with the<br />
        CVSU-Imus community through<br />
        Extension Services.
      </p>
    </div>

    <!-- Right Panel -->
    <div class="right-card" id="right-panel">
      <div class="panel-content" id="panel-content">
        <img src="etracker.png" alt="eTracker Icon" class="w-42 h-32 mb-4" />
        <div class="button" onclick="showRegisterForm()">REGISTER</div>
        <div class="button" onclick="handleLogin()">LOG IN</div>
      </div>
    </div>
  </div>

  <script>
    let userData = {}; // To store user_id and role after initial registration
    let userEmail = ''; // Store user email for OTP
    let otpTimer = null; // Timer for OTP resend cooldown
    let otpExpirationTime = null; // Store OTP expiration timestamp

    function showRegisterForm() {
      const rightPanel = document.getElementById('right-panel');
      const panelContent = document.getElementById('panel-content');

      // Trigger exit animation
      panelContent.classList.add('exit');

      // Wait for the exit animation to finish, then replace with new content
      setTimeout(() => {
        // Replace the entire panel content
        rightPanel.innerHTML = `
          <div class="panel-content enter-start">
            <div class="form-title">REGISTER</div>
            <input type="text" id="firstname" placeholder="Firstname" class="form-input" />
            <div class="name-row">
              <input type="text" id="lastname" placeholder="Lastname" class="form-input lastname" />
              <input type="text" id="mi" placeholder="M.I." class="form-input mi" />
            </div>
            <input type="email" id="email" placeholder="Email (@cvsu.edu.ph only)" class="form-input" />
            <input type="password" id="password" placeholder="Password" class="form-input" />
            <input type="password" id="confirm-password" placeholder="Confirm Password" class="form-input" />
            <div class="radio-group">
              <span>User Role:</span>
              <div class="radio-options">
                <div class="radio-option">
                  <input type="radio" id="student" name="role" value="student" checked />
                  <label for="student">Student</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="non_acad" name="role" value="non_acad" />
                  <label for="non_acad">Non-Acad</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="faculty" name="role" value="faculty" />
                  <label for="faculty">Faculty</label>
                </div>
              </div>
            </div>
            <img src="arrow.png" alt="Submit Arrow" class="submit-arrow" onclick="submitInitialForm()" />
          </div>
        `;

        // Find the new panel content and apply the enter animation
        const newContent = rightPanel.querySelector('.panel-content');
        setTimeout(() => {
          newContent.classList.remove('enter-start');
          newContent.classList.add('enter');
        }, 10); // Small delay to ensure the animation triggers
      }, 600); // Match the transition duration (0.6s)
    }

    function handleLogin() {
      const rightPanel = document.getElementById('right-panel');
      const panelContent = document.getElementById('panel-content');

      // Trigger exit animation
      panelContent.classList.add('exit');

      // Wait for the exit animation to finish, then replace with login form
      setTimeout(() => {
        rightPanel.innerHTML = `
          <div class="panel-content enter-start">
            <div class="form-title">LOG IN</div>
            <input type="email" id="login-email" placeholder="Email" class="form-input" />
            <input type="password" id="login-password" placeholder="Password" class="form-input" />
            <div class="button" onclick="submitLoginForm()">LOG IN</div>
          </div>
        `;

        const newContent = rightPanel.querySelector('.panel-content');
        setTimeout(() => {
          newContent.classList.remove('enter-start');
          newContent.classList.add('enter');
        }, 10);
      }, 600);
    }

    function submitLoginForm() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      // Validate login form
      if (!email || !password) {
        alert("Please fill out all required fields.");
        return;
      }

      // Send login data to the server
      fetch('login.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email, password })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Redirect to the appropriate page based on role
          window.location.href = data.redirect_url;
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred during login.');
      });
    }

    function submitInitialForm() {
      const firstname = document.getElementById('firstname').value;
      const lastname = document.getElementById('lastname').value;
      const mi = document.getElementById('mi').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const role = document.querySelector('input[name="role"]:checked').value;

      // Validate required fields
      if (!firstname || !lastname || !email || !password || !confirmPassword) {
        alert("Please fill out all required fields.");
        return;
      }

      // Validate email domain
      if (!email.toLowerCase().endsWith('@cvsu.edu.ph')) {
        alert("Only @cvsu.edu.ph email addresses are allowed for registration.");
        return;
      }

      // Validate password match
      if (password !== confirmPassword) {
        alert("Passwords do not match!");
        return;
      }

      // Store email for OTP use
      userEmail = email;

      // Send initial registration data to the server
      fetch('register.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          firstname,
          lastname,
          mi,
          email,
          password,
          role
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }
        return response.text(); // Get text first to handle empty responses
      })
      .then(text => {
        try {
          const data = JSON.parse(text);
          if (data.status === 'success') {
            userData = { user_id: data.user_id, role: data.role };
            if (data.next_step === 'otp_verification') {
              showOTPVerificationForm();
            } else {
              showRoleSpecificForm();
            }
          } else {
            // Log full error details to console
            console.error('Registration error:', data);
            // Show detailed error if available
            const errorMsg = data.message + (data.detail ? '\n\nDetails: ' + data.detail : '');
            alert(errorMsg);
          }
        } catch (e) {
          console.error('JSON parse error:', e);
          console.error('Response text:', text);
          alert('Server returned invalid response. Please check console for details.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred during registration: ' + error.message);
      });
    }

    function showOTPVerificationForm() {
      const rightPanel = document.getElementById('right-panel');
      const panelContent = rightPanel.querySelector('.panel-content');

      // Trigger exit animation
      panelContent.classList.add('exit');

      // Wait for the exit animation to finish, then replace with OTP form
      setTimeout(() => {
        rightPanel.innerHTML = `
          <div class="panel-content enter-start">
            <div class="form-title">VERIFY EMAIL</div>
            <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 14px;">
              We've sent a 6-digit verification code to your email.<br>
              Please enter it below to continue.
            </p>
            <div id="otp-inputs" class="otp-inputs">
              <input type="text" maxlength="1" class="otp-digit" id="otp-1" />
              <input type="text" maxlength="1" class="otp-digit" id="otp-2" />
              <input type="text" maxlength="1" class="otp-digit" id="otp-3" />
              <input type="text" maxlength="1" class="otp-digit" id="otp-4" />
              <input type="text" maxlength="1" class="otp-digit" id="otp-5" />
              <input type="text" maxlength="1" class="otp-digit" id="otp-6" />
            </div>
            <div id="otp-timer" class="otp-timer">Resend code in 60s</div>
            <div class="otp-actions">
              <button class="button" onclick="resendOTP()" id="resend-btn" disabled>RESEND CODE</button>
              <button class="button" onclick="verifyOTPCode()">VERIFY</button>
            </div>
            <div class="otp-links">
              <a href="#" onclick="goBackToInitialForm()" style="color: #666; font-size: 14px;">Change Email</a>
            </div>
          </div>
        `;

        const newContent = rightPanel.querySelector('.panel-content');
        setTimeout(() => {
          newContent.classList.remove('enter-start');
          newContent.classList.add('enter');
        }, 10);

        // Auto-send OTP when form loads
        sendOTP();

        // Set up OTP input handling
        setupOTPInputs();
      }, 600);
    }

    function loadDepartments() {
      fetch('get_departments.php?action=get_departments')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const departmentSelect = document.getElementById('department');
            departmentSelect.innerHTML = '<option value="" disabled selected>Select Department</option>';
            data.data.forEach(dept => {
              const option = document.createElement('option');
              option.value = dept;
              option.textContent = dept;
              departmentSelect.appendChild(option);
            });
          } else {
            console.error('Failed to load departments:', data.error);
            alert('Failed to load departments. Please try again.');
          }
        })
        .catch(error => {
          console.error('Error loading departments:', error);
          alert('Error loading departments. Please check your connection.');
        });
    }

    function showRoleSpecificForm() {
      const rightPanel = document.getElementById('right-panel');
      const panelContent = rightPanel.querySelector('.panel-content');

      // Trigger exit animation
      panelContent.classList.add('exit');

      // Wait for the exit animation to finish, then replace with new content
      setTimeout(() => {
        let newContentHTML = '';
        if (userData.role === 'student' || userData.role === 'non_acad') {
          const roleTitle = userData.role === 'student' ? 'STUDENT' : 'NON-ACAD';
          newContentHTML = `
            <div class="panel-content enter-start">
              <div class="form-title text-green-800">${roleTitle}</div>
              <input type="text" id="contact-no" placeholder="Contact No." class="form-input" />
              <input type="text" id="emergency-contact" placeholder="Emergency Contact" class="form-input" />
              <div class="flex items-center my-4">
                <input type="checkbox" id="terms-student" class="mr-2 accent-green-800 transform scale-125" />
                <label for="terms-student" class="text-sm text-gray-600">I have read and agree to the Terms and Condition</label>
              </div>
              <div class="flex gap-4">
                <button class="button" onclick="goBackToRoleSelection()" style="flex: 1; background-color: #6b7280;">BACK</button>
                <button class="button" onclick="submitRoleSpecificForm()" style="flex: 2;">REGISTER</button>
              </div>
            </div>
          `;
        } else if (userData.role === 'faculty') {
          newContentHTML = `
            <div class="panel-content enter-start">
              <div class="form-title text-green-800">FACULTY</div>
              <select id="department" class="form-input">
                <option value="" disabled selected>Loading departments...</option>
              </select>
              <input type="text" id="position" placeholder="Position" class="form-input" />
              <div class="flex items-center my-4">
                <input type="checkbox" id="terms-faculty" class="mr-2 accent-green-800 transform scale-125" />
                <label for="terms-faculty" class="text-sm text-gray-600">I have read and agree to the Terms and Condition</label>
              </div>
              <div class="button" onclick="submitRoleSpecificForm()">REGISTER</div>
            </div>
          `;
        }

        // Replace the entire panel content
        rightPanel.innerHTML = newContentHTML;

        // Load departments if faculty form
        if (userData.role === 'faculty') {
          loadDepartments();
        }

        // Find the new panel content and apply the enter animation
        const newContent = rightPanel.querySelector('.panel-content');
        setTimeout(() => {
          newContent.classList.remove('enter-start');
          newContent.classList.add('enter');
        }, 10); // Small delay to ensure the animation triggers
      }, 600); // Match the transition duration (0.6s)
    }

    function submitRoleSpecificForm() {
      let data = { user_id: userData.user_id, role: userData.role };

      if (userData.role === 'student' || userData.role === 'non_acad') {
        const contactNo = document.getElementById('contact-no').value;
        const emergencyContact = document.getElementById('emergency-contact').value;
        const termsChecked = document.getElementById('terms-student').checked;

        // Validate required fields
        if (!contactNo || !emergencyContact) {
          alert("Please fill out all required fields.");
          return;
        }

        if (!termsChecked) {
          alert("Please agree to the Terms and Conditions.");
          return;
        }

        data.contact_no = contactNo;
        data.emergency_contact = emergencyContact;
      } else if (userData.role === 'faculty') {
        const department = document.getElementById('department').value;
        const position = document.getElementById('position').value;
        const termsChecked = document.getElementById('terms-faculty').checked;

        // Validate required fields
        if (!department || !position) {
          alert("Please fill out all required fields.");
          return;
        }

        if (!termsChecked) {
          alert("Please agree to the Terms and Conditions.");
          return;
        }

        data.department = department;
        data.position = position;
      }

      // Send role-specific data to the server
      fetch('register.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }
        return response.text();
      })
      .then(text => {
        try {
          const data = JSON.parse(text);
          if (data.status === 'success') {
            alert(data.message);
            // Optionally redirect or reset the form
            window.location.reload();
          } else {
            // Log full error details to console
            console.error('Registration error:', data);
            // Show detailed error if available
            const errorMsg = data.message + (data.detail ? '\n\nDetails: ' + data.detail : '');
            alert(errorMsg);
          }
        } catch (e) {
          console.error('JSON parse error:', e);
          console.error('Response text:', text);
          alert('Server returned invalid response. Please check console for details.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred during registration: ' + error.message);
      });
    }

    function sendOTP() {
      if (!userEmail) {
        alert('Email not found. Please restart registration.');
        return;
      }

      fetch('send_otp.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userData.user_id, email: userEmail })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          startOTPTimer();
          alert('OTP sent to your email successfully!');
        } else {
          alert('Failed to send OTP: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please try again.');
      });
    }

    function verifyOTPCode() {
      const otpDigits = [];
      for (let i = 1; i <= 6; i++) {
        const digit = document.getElementById(`otp-${i}`).value;
        if (!digit) {
          alert('Please enter the complete 6-digit code.');
          return;
        }
        otpDigits.push(digit);
      }

      const otpCode = otpDigits.join('');

      fetch('verify_otp.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userData.user_id, otp_code: otpCode })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          showRoleSpecificForm();
        } else {
          alert('Verification failed: ' + data.message);
          // Clear OTP inputs on failure
          for (let i = 1; i <= 6; i++) {
            document.getElementById(`otp-${i}`).value = '';
          }
          document.getElementById('otp-1').focus();
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please try again.');
      });
    }

    function resendOTP() {
      const resendBtn = document.getElementById('resend-btn');
      resendBtn.disabled = true;
      resendBtn.textContent = 'SENDING...';

      sendOTP();

      // Reset button after sending
      setTimeout(() => {
        resendBtn.textContent = 'RESEND CODE';
      }, 1000);
    }

    function setupOTPInputs() {
      const inputs = document.querySelectorAll('.otp-digit');

      inputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          // Only allow numbers
          e.target.value = e.target.value.replace(/[^0-9]/g, '');

          // Auto-focus next input
          if (e.target.value && index < inputs.length - 1) {
            inputs[index + 1].focus();
          }
        });

        input.addEventListener('keydown', (e) => {
          // Handle backspace
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            inputs[index - 1].focus();
          }

          // Handle Enter key to submit
          if (e.key === 'Enter') {
            verifyOTPCode();
          }
        });

        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const paste = e.clipboardData.getData('text');
          const digits = paste.replace(/[^0-9]/g, '').slice(0, 6);

          digits.split('').forEach((digit, i) => {
            if (inputs[index + i]) {
              inputs[index + i].value = digit;
            }
          });

          // Focus the next empty input or the last input
          const nextIndex = Math.min(index + digits.length, inputs.length - 1);
          inputs[nextIndex].focus();
        });
      });

      // Focus first input
      inputs[0].focus();
    }

    function startOTPTimer() {
      let timeLeft = 60;
      const timerElement = document.getElementById('otp-timer');
      const resendBtn = document.getElementById('resend-btn');

      if (otpTimer) clearInterval(otpTimer);

      otpTimer = setInterval(() => {
        timerElement.textContent = `Resend code in ${timeLeft}s`;
        resendBtn.disabled = true;

        timeLeft--;

        if (timeLeft < 0) {
          clearInterval(otpTimer);
          timerElement.textContent = 'You can now resend the code';
          resendBtn.disabled = false;
          resendBtn.textContent = 'RESEND CODE';
        }
      }, 1000);
    }

    function goBackToInitialForm() {
      const rightPanel = document.getElementById('right-panel');
      const panelContent = rightPanel.querySelector('.panel-content');

      // Trigger exit animation
      panelContent.classList.add('exit');

      // Wait for the exit animation to finish, then replace with initial registration form
      setTimeout(() => {
        rightPanel.innerHTML = `
          <div class="panel-content enter-start">
            <div class="form-title">REGISTER</div>
            <input type="text" id="firstname" placeholder="Firstname" class="form-input" />
            <div class="name-row">
              <input type="text" id="lastname" placeholder="Lastname" class="form-input lastname" />
              <input type="text" id="mi" placeholder="M.I." class="form-input mi" />
            </div>
            <input type="email" id="email" placeholder="Email" class="form-input" />
            <input type="password" id="password" placeholder="Password" class="form-input" />
            <input type="password" id="confirm-password" placeholder="Confirm Password" class="form-input" />
            <div class="radio-group">
              <span>User Role:</span>
              <div class="radio-options">
                <div class="radio-option">
                  <input type="radio" id="student" name="role" value="student" checked />
                  <label for="student">Student</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="non_acad" name="role" value="non_acad" />
                  <label for="non_acad">Non-Acad</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="faculty" name="role" value="faculty" />
                  <label for="faculty">Faculty</label>
                </div>
              </div>
            </div>
            <img src="arrow.png" alt="Submit Arrow" class="submit-arrow" onclick="submitInitialForm()" />
          </div>
        `;

        const newContent = rightPanel.querySelector('.panel-content');
        setTimeout(() => {
          newContent.classList.remove('enter-start');
          newContent.classList.add('enter');
        }, 10);
      }, 600);
    }

    function goBackToRoleSelection() {
      const rightPanel = document.getElementById('right-panel');
      const panelContent = rightPanel.querySelector('.panel-content');

      // Trigger exit animation
      panelContent.classList.add('exit');

      // Wait for the exit animation to finish, then replace with initial registration form
      setTimeout(() => {
        rightPanel.innerHTML = `
          <div class="panel-content enter-start">
            <div class="form-title">REGISTER</div>
            <input type="text" id="firstname" placeholder="Firstname" class="form-input" />
            <div class="name-row">
              <input type="text" id="lastname" placeholder="Lastname" class="form-input lastname" />
              <input type="text" id="mi" placeholder="M.I." class="form-input mi" />
            </div>
            <input type="email" id="email" placeholder="Email" class="form-input" />
            <input type="password" id="password" placeholder="Password" class="form-input" />
            <input type="password" id="confirm-password" placeholder="Confirm Password" class="form-input" />
            <div class="radio-group">
              <span>User Role:</span>
              <div class="radio-options">
                <div class="radio-option">
                  <input type="radio" id="student" name="role" value="student" checked />
                  <label for="student">Student</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="non_acad" name="role" value="non_acad" />
                  <label for="non_acad">Non-Acad</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="faculty" name="role" value="faculty" />
                  <label for="faculty">Faculty</label>
                </div>
              </div>
            </div>
            <img src="arrow.png" alt="Submit Arrow" class="submit-arrow" onclick="submitInitialForm()" />
          </div>
        `;

        const newContent = rightPanel.querySelector('.panel-content');
        setTimeout(() => {
          newContent.classList.remove('enter-start');
          newContent.classList.add('enter');
        }, 10);
      }, 600);
    }
  </script>
</body>
</html>