<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>eTracker Admin Dashboard</title>
  <link rel="stylesheet" href="Dashboard.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="sidebar">
    <h2>eTracker Admin</h2>
    <a href="Dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
    <a href="User.html"><i class="fas fa-users"></i> User Management</a>
    <a href="Programs.html"><i class="fas fa-calendar-alt"></i> Project Management</a>
        <a href="ProjectEvaluation.html"><i class="fas fa-clipboard-check"></i> Project Evaluation</a>
    <a href="Attendance.html"><i class="fas fa-check-square"></i> Attendance Tracker</a>
    <a href="Evaluation.html"><i class="fas fa-poll"></i> Evaluation & Feedback</a>
    <a href="Reports.html"><i class="fas fa-chart-bar"></i> Reports & Analytics</a>
    <a href="Document.html"><i class="fas fa-folder"></i> Document Management</a>
    <a href="Certificates.html"><i class="fas fa-certificate"></i> Certificates</a>
    <a href="Notifications.html"><i class="fas fa-bell"></i> Notifications</a>
  <a href="../portal/home/home.html"><i class="fas fa-external-link-alt"></i> Portal</a>
    
    <div style="margin-top: auto; padding-top: 20px;">
  <a href="../register/logout.php" style="color: none; text-decoration: none; display: block; padding: 12px 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.1);">
        <i class="fas fa-sign-out-alt"></i> Sign Out
      </a>
    </div>
  </div>

  <div class="main">
    <div class="main-header" style="margin-bottom:2rem;">
      <h1>Dashboard Overview</h1>
      <input class="search" type="text" placeholder="Search..." />
      <div class="header-icons">
        <span class="notif"><i class="fas fa-bell"></i></span>
      </div>
    </div>

    <!-- Dashboard Cards -->
    <div class="cards" style="margin-bottom:2rem;">
      <div class="card">
        <div class="card-title">Total Students</div>
        <div class="card-value" id="stat-students">-</div>
      </div>
      <div class="card">
        <div class="card-title">Non-Acad Users</div>
        <div class="card-value" id="stat-non-acad">-</div>
      </div>
      <div class="card">
        <div class="card-title">Faculty Members</div>
        <div class="card-value" id="stat-faculty">-</div>
      </div>
      <div class="card">
        <div class="card-title">Ongoing Programs</div>
        <div class="card-value" id="stat-programs">-</div>
      </div>
      <div class="card">
        <div class="card-title">Certificates Issued</div>
        <div class="card-value" id="stat-certificates">-</div>
      </div>
    </div>

    <div style="display: flex; flex-wrap: wrap; gap: 2rem;">
      <!-- Left Column -->
      <div style="flex:2; min-width:320px;">
        <!-- <div class="panel" style="margin-bottom:1.5rem;">
          <h3>Program Trends</h3>
          <canvas id="programTrendsChart" height="180"></canvas>
        </div> -->
        <div class="panel" style="margin-bottom:1.5rem;">
          <h3>Uploaded Programs</h3>
          <div style="display: flex; gap: 1rem; align-items: center;">
            <div style="flex: 1;">
              <h4 style="text-align: center; margin-bottom: 0.5rem;">Programs by Department</h4>
              <canvas id="programsByDeptChart" width="120" height="120" style="width: 120px; height: 120px; display: block; margin: 0 auto;"></canvas>
              <p style="text-align:center;font-weight:bold; margin-top: 0.5rem;" id="totalProgramsLabel">-- Programs</p>
            </div>
            <div style="flex: 1;">
              <h4 style="text-align: center; margin-bottom: 0.5rem;">Top 3 Departments</h4>
              <canvas id="topDeptsChart" height="120"></canvas>
            </div>
          </div>
        </div>
        <div class="panel" style="margin-bottom:1.5rem;">
          <h3>Upcoming Sessions</h3>
          <ul id="upcomingSessionsList" style="padding-left:0;list-style:none;"></ul>
        </div>
        <div class="panel">
          <h3>Feedback Highlights</h3>
          <div class="feedback-box" id="feedbackHighlight">
            "The speaker was very engaging and made the content easy to understand."
          </div>
        </div>
      </div>
      <!-- Right Column -->
      <div style="flex:1; min-width:320px;">
        <div class="panel" style="margin-bottom:1.5rem;">
          <h3>Attendance Rate</h3>
          <canvas id="attendanceRateChart" width="120" height="120"></canvas>
          <p style="text-align:center;font-weight:bold;" id="attendanceRateLabel">--%</p>
        </div>
        <div class="panel" style="margin-bottom:1.5rem;">
          <h3>Quick Actions</h3>
          <div class="quick-actions">
            <button onclick="window.location.href='Programs.html'"><i class="fas fa-plus"></i> Create Program</button>
            <button onclick="window.location.href='Reports.html'"><i class="fas fa-file-export"></i> Export Report</button>
          </div>
        </div>
        <div class="panel notifications">
          <h3>Notifications</h3>
          <p>3 students missed attendance yesterday.</p>
          <p>Feedback deadline for Program X is today.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
async function loadDashboardStats() {
  try {
    const res = await fetch('../backend/dashboard_stats.php');
    if (!res.ok) {
      throw new Error('Failed to fetch stats');
    }
    const stats = await res.json();

    document.getElementById('stat-students').innerText = stats.students || 0;
    document.getElementById('stat-non-acad').innerText = stats.non_acad || 0;
    document.getElementById('stat-faculty').innerText = stats.faculty || 0;
    document.getElementById('stat-programs').innerText = stats.programs || 0;
    document.getElementById('stat-certificates').innerText = stats.certificates || 0;

    // Attendance Rate Chart
    const ctxAttendance = document.getElementById('attendanceRateChart').getContext('2d');
    document.getElementById('attendanceRateLabel').innerText = (stats.attendanceRate || 0) + "%";
    new Chart(ctxAttendance, {
      type: 'doughnut',
      data: {
        labels: ['Present', 'Absent'],
        datasets: [{
          data: [stats.attendanceRate || 0, 100 - (stats.attendanceRate || 0)],
          backgroundColor: ['#1B472B', '#e5e7eb'],
          borderWidth: 0
        }]
      },
      options: {
        cutout: '75%',
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false }
        }
      }
    });

    // Upcoming Sessions
    const upcomingList = document.getElementById('upcomingSessionsList');
    upcomingList.innerHTML = '';
    (stats.upcomingSessions || []).forEach(s =>
      upcomingList.innerHTML += `<li style="display:flex;justify-content:space-between;margin-bottom:8px;">
        <span>${new Date(s.date).toLocaleDateString()}</span>
        <span>${s.program_name}</span>
      </li>`
    );

    // Feedback Highlight (random)
    document.getElementById('feedbackHighlight').innerText =
      (stats.feedback && stats.feedback.length) ? stats.feedback[Math.floor(Math.random() * stats.feedback.length)] : 'No feedback yet.';

    // Programs by Department (Donut Chart)
    const ctxDept = document.getElementById('programsByDeptChart').getContext('2d');
    const deptLabels = stats.programsByDept?.labels || [];
    const deptData = stats.programsByDept?.data || [];
    if (deptLabels.length > 0 && deptData.length > 0) {
      // Create a diverse color palette for departments
      const deptColors = [
        '#1B472B', // Dark green
        '#2563EB', // Blue
        '#DC2626', // Red
        '#EA580C', // Orange
        '#7C3AED', // Purple
        '#059669', // Emerald
        '#DB2777', // Pink
        '#D97706', // Amber
        '#4F46E5', // Indigo
        '#0891B2'  // Cyan
      ];

      // Calculate total programs
      const totalPrograms = deptData.reduce((sum, count) => sum + count, 0);
      document.getElementById('totalProgramsLabel').innerText = totalPrograms + " Programs";

      new Chart(ctxDept, {
        type: 'doughnut',
        data: {
          labels: deptLabels,
          datasets: [{
            data: deptData,
            backgroundColor: deptColors.slice(0, deptLabels.length),
            borderWidth: 0
          }]
        },
        options: {
          cutout: '75%',
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          }
        }
      });
    }

    // Top 4 Departments (Bar Chart)
    const ctxTop = document.getElementById('topDeptsChart').getContext('2d');
    const topLabels = stats.topDepts?.labels || [];
    const topData = stats.topDepts?.data || [];
    if (topLabels.length > 0 && topData.length > 0) {
      // Use the same color palette as the donut chart
      const barColors = [
        '#1B472B', // Dark green
        '#2563EB', // Blue
        '#DC2626'  // Red
      ];

      new Chart(ctxTop, {
        type: 'bar',
        data: {
          labels: topLabels,
          datasets: [{
            label: 'Programs',
            data: topData,
            backgroundColor: barColors.slice(0, topLabels.length)
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Program Trends Chart
    /*
    const ctxTrends = document.getElementById('programTrendsChart').getContext('2d');
    const labels = stats.programTrends?.labels || [];
    const data = stats.programTrends?.data || [];
    const hasData = data.some(d => d > 0);
    if (labels.length > 0 && data.length > 0 && hasData) {
      new Chart(ctxTrends, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Enrollment',
            data: data,
            backgroundColor: '#1B472B'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    } else {
      // If no data or all zero, show a message
      const canvas = document.getElementById('programTrendsChart');
      const ctx = canvas.getContext('2d');
      ctx.font = '16px Arial';
      ctx.fillText('No enrollment data available', 10, 50);
    }
    */
  } catch (error) {
    console.error('Error loading dashboard stats:', error);
    // Optionally show error in UI
    document.getElementById('stat-students').innerText = 'Error';
    document.getElementById('stat-non-acad').innerText = 'Error';
    document.getElementById('stat-faculty').innerText = 'Error';
    document.getElementById('stat-programs').innerText = 'Error';
    document.getElementById('stat-certificates').innerText = 'Error';
  }
}

window.addEventListener('DOMContentLoaded', loadDashboardStats);
  </script>
</body>
</html>
